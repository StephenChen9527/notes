# kafka
## kafka定义
**kafka是一个<label style="color:red">分布式</label>的<label style="color:red">发布/订阅模式</label>的<label style="color:red">消息队列</label>**

## 消息队列应用场景

常用来进行异步处理

![异步处理](https://tvax3.sinaimg.cn/large/005VwC5mly1gci63t3ckej30op0d7q52.jpg)

一般好像kafka都是用来传输日志的。

## 使用kafka的好处

1. 解耦

解耦是最明显的一个体现，能将原本耦合在程序中的某些功能，抽取出来，成为一个单独的服务，然后消息队列进行通信，例如：日志，可以通过卡夫卡发送日志到kafka平台，然后日志服务，在进行消息的消费，发送日志的服务，可以大大缩减IO操作时间，增强了业务，也将自己主要的精力用于开发业务逻辑中去，还有其他各种可以将业务逻辑拆分开来，通过kafka通信的场景都可以考虑使用它。主要有一点：无法准确的、及时的关注到消费的情况。

2. 可恢复性

当某个消费kafka消息的平台挂掉的时候，不至于让自己系统也阻塞到哪里，虽然多线程异步信息也可以不阻塞，但是消息如果不发送，就会积压在自己系统内，并且需要实时监听对方的服务是否正常，但是如果发送到kafka后，就无需积压在自己，只要消费的系统起来，再去读取消息队列，还能继续正常的业务处理，并且消息队列还保存了一个先后顺序，不过大量的消息积压，肯定还是会让kafka宕机的。

3. 缓冲（流量削峰）

缓冲其实感觉跟峰值处理能力都有一点点重合，甚至说，他就是那么个玩意。缓冲就是让消费者与生产者之间的一个速度平衡，比如 我司的日志平台，全部项目接入，大量的日志输入，如果没有中间件，单单用直连肯定在流量大的时候搞挂。

4. 灵活性 & 峰值处理能力

感觉跟缓冲很相似，就是在流量大的时候，做一个缓冲，但是不可能时时刻刻流量都很大，如果按照流量的峰值去部署消费者，流量小的时候是很浪费的

5. 异步通信（发送日志、订单等信息通知其他人）

异步通信也是一个非常大的点，可以将消息放入kafka，不用时时刻刻消费，只需要在需要的时候去消费。


## 消息队列的模式
* 点对点模式

一对一、消费者主动拉取（监听）数据，消息收到后消息消除。

![点对点模式](https://tvax4.sinaimg.cn/large/005VwC5mly1gci7223pzjj30op0aa768.jpg)

* 发布/订阅模式

一对多，消费者消费数据之后，不会清除消息。

在这里，消费着消费消息有两种：
  1. 消费者主动拉取消息
  2. 队列主动推送到各个消费者

![发布/订阅模式](https://tva4.sinaimg.cn/large/005VwC5mly1gci7ctca95j30o109xtaf.jpg)


## kafka的架构

![kafka架构](https://tva3.sinaimg.cn/large/005VwC5mly1gdcevv7fz4j31170hz0w3.jpg)

#### 相关概念
* Producer：生产者，向kafka发送消息
* Consumer：消费者，向kafka读取消息
* Consumer Group(CG)：消费者组，由多个consumer组成。消费者组内每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费；消费者组之间互不影响。所以有的消费者都来自某个消费者组，即消费者组是逻辑上的一个订阅者。（一个消费者可以对应消费多个分区，但是一个分区不同被同一个组内的多个消费者消费，同一个分区可以被不同的消费者组消费）
* Broker：一个 kafka服务器 就是一个 Broker，一个集群有多个broker组成，一个broker可以容纳多个topic。
* Topic：逻辑上的一个队列，是消息主题，每一个Topic就是一个分类。生产者和消费者面向的都是一个topic。
* Partition：分区，方便水平扩展，一个broker里面的同一个topic可以有一个或者多个分区。每个partition都是一个有序的队列。分区的 leader与follower分布在不同的broker。跟broker有点关系。。。（每个分区的leader+follower的数量）
* Replica：副本，备份数据,副本的个数不能超过broker数，副本数最大为broker数一致，如果不一致，那么他的如果一台挂掉了，其实副本数量可能会挂掉2个，没什么意义？


#### kafka
kafka创建新的Topic的时候，指定副本为2的时候，总共会有两个，一个是master副本，一个follower副本。而不是1个master，2个follower副本。


#### 工作机制
