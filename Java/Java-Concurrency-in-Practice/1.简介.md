# 1.简介
## 并发简史
在早起计算机中，不包含操作系统，它们从头到尾只执行一个程序，并且这个程序能访问计算机中所有的资源。

之所以要再计算机中加入操作系统来实现多个程序的同事执行，主要是基于以下原因：
1. 资源利用率
2. 公平性
3. 便利性

线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程都有各自的程序计数器、栈以及局部变量等。

线程被称为轻量级进程。在大多数现代操作系统中，都是以线程为基本的调度单位，而不是进程。

如果没有明确的协同机制，那么线程将彼此独立执行。

## 线程的优势
如果使用得当，线程可以有效地降低程序的开发和维护成本，同时提升复杂应用程序的性能。

线程能将绝大部分的异步工作流转换成穿行工作流。

`发挥多处理器的强大能力`：

由于基本的调度单位是线程，因此如果在在程序中只有一个线程，那么最多同时只能在一个处理器上运行。会造成多核CPU的浪费。

多线程程序可以通过提高处理器资源的利用率来提升系统吞吐率。

`建模的简单性`：

如果将模型中每种类的任务都分配一个专门的线程，那么可以形成一种串行执行的假象，并将程序的执行逻辑与调度机制的细节，交替执行的操作，异步`I/O`以及资源等待等问题分离开来。

通过使用线程，可以将复杂并且异步的工作流进一步分解为一组简单并且同步的工作流，每个工作流在一个单独的线程中运行，并在特定的同步位置进行交互。

`异步事件的简化处理`：

服务器应用程序在接受来自多个远程客户端的套接字连接请求时，如果为每个连接都分配其各自的线程并且使用同步`I/O`，那么就会降低这类程序的开发难度。

如果某个应用程序对套接字执行读操作而此时还没有数据到来，那么这个读操作将一直祖册，直到有数据到达。在单线程应用程序中，不仅意味着处理请求的过程中将停顿，而且还以为着这个线程被阻塞期间，对所有请求的处理都将停顿。


操作系统提供了一些高效的方法来实现多路`I/O`。

`响应更灵敏的用户界面`：
传统的`GUI`应用程序通常是单线程的。

在现代的`GUI`框架中，如`AWT`和`Swing`等，都是采用一个事件分发线程来代替主事件循环。

## 线程带来的风险

线程带来的风险就是在多个线程同时执行中，执行顺序是不可预测的，如代码：

![不安全代码](https://tvax1.sinaimg.cn/large/005VwC5mly1g82gvyu36fj30he07m0u2.jpg)

在这个获取value的时候，进行自增，这个看似一个操作，其实是三个操作：
1. 读取value（从主线程写入本线程内存）
2. value+1（本线程内存中操作）
3. 写会value（写到主线程）

由于在上面三步中，任意一部CPU都可能进行切换，如果这个时候读取了value是100，然后加了1，CPU调度其他线程操作，也读取value是100，然后加了1，然后线程调回去，写入线程，value成为101，在调度会线程2，写入101。

这个时候就发生了问题，串行情况下应该是102的，但是上面产生了101的结果。

这个就是不正确性，如图：

![时序图](https://tva1.sinaimg.cn/large/005VwC5mly1g82h5i7rapj311x0et13w.jpg)
