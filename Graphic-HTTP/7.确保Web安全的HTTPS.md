### 确保Web安全的HTTPS
HTTP协议并不安全，因此退出来HTTPS协议（S代表Security安全）。
###### HTTP的缺点
* 通信使用明文（不加密），可能被窃听
* 不验证通信方的身份，因此可能遭遇伪装
* 无法验证报文的完整性，所以有可能已遭篡改

以下为HTTP中存在的各种问题。

###### 通信使用明文可能被窃听
因为TCP/IP协议族的工作机制，因此通信内容在所有的通信线路上都有可能被窥视。
![通信回环可能被窃听](https://wx3.sinaimg.cn/large/005VwC5mly1g73sie7684j30w80eaqc7.jpg)

> 每一个在局域网（LAN）上的工作站都有其硬件地址(MAC地址)，这些地址惟一地表示了网络上的机器（这一点与Internet地址系统比较相似）。当用户发送一个数据包时，这些数据包就会发送到LAN上所有可用的机器。    baidubaike-->sniffer

因此数据如果是明文即HTTP协议，同局域网下，直接就被嗅探工具`sniffer`抓到。

###### 加密处理防止被窃听
通过SSL（Secure Socket Layer，安全套接层）或TLS（Transport Layer Security，安全层传输协议）的组合使用，加密HTTP。

与SSL组合使用的HTTP被称为HTTPS。

内容加密：客户端与服务器将报文内容进行加密（其实无法杜绝篡改，监听等问题）。

###### 任何人都可以发出请求
在HTTP协议通信时，不存在确认通信方的处理步骤，任何人都可以请求，不管请求方是谁，也都会返回响应（不包含用其他方式禁用IP等进制访问）。
HTTP协议存在的隐患
* 无法确定请求发送至目标的Web服务器是否是按照真实意愿返回喜爱宁的那台服务器，有可能是伪装的Web服务器。
* 无法确定响应返回到的客户端是否按真实意图接收响应的那个客户端，有可能是伪装的客户端。
* 无法确定正在通信的双方是否具备访问权限。
* 无法判断请求是来自何方（不是有IP吗？可能IP不准确？）。
* 及时是无意义的请求也会被响应。（DDOS攻击）

###### 查明对手的证书
SSL不仅提供加密处理，还提供证书手段，用于确定对方。伪造证书是一件非常困难的事情。

SSL应该在建立连接前先检查证书，是否是要请求的服务器，现象（某些小站虽然支持HTTPS，但是证书不可靠，因此需要用户手动点继续才可以继续访问）。

![SSL证书](https://wx2.sinaimg.cn/large/005VwC5mly1g73tkssjxdj30yo0fywr8.jpg)

通过证书，可以证明通信方就是那个服务器，减少了使用者个人信息泄露的危险性。

###### 接收到的内容可能有误
由于HTTP协议无法证明通信报文的完整性，因此在请求或者响应的途中，存在被篡改的风险。

![中间人攻击](https://ws3.sinaimg.cn/large/005VwC5mly1g74kigo0d2j30rp0g5dpc.jpg)

###### 如何放篡改
HTTP协议虽然可以确定报文的完整性，常用的是MD5和SHA-1等散列值校验的方法，以及用来确认文件的数字签名方法。

##### HTTP+加密+认证+完整性保护=HTTPS

![HTTPS通信](https://ws3.sinaimg.cn/large/005VwC5mly1g74kts7eczj30zl0ffjyr.jpg)

在HTTP上加入加密处理和认证等机制，我们就把这种的HTTP请求称为HTTPS。

###### HTTPS是身披SSL外壳的HTTP
HTTPS并非是应用层的新协议，只是HTTP通信接口部分用SSL和TLS协议代替了而已。

通常HTTP直接与TCP通信，当使用HTTPS的时候，就变成HTTP与SSL通信，SSL再与TCP进行通信。

![HTTP与HTTPS](https://ws4.sinaimg.cn/large/005VwC5mly1g74l0wtz5oj30q40bqgnb.jpg)

###### 相互交换秘钥的公开秘钥加密技术
SSL采用的是`公开密钥加密`（`Public-key cryptography`）的加密处理方式。


HTTPS采用混合加密机制。

HTTPS采用共享密钥加密和公开密钥加密两者并用的混合加密机制。

考虑到效率问题，在交换密钥环节使用公开密钥加密方式，之后建立通信加密报文阶段则使用共享密钥加密方式。

![交换密钥](https://wx2.sinaimg.cn/large/005VwC5mly1g74m2fgr61j30sc0mkand.jpg)

在我看来，在TCP建立连接后，会先进行交换共享密钥，这个阶段是用公开密钥进行的，交换完成之后，再进行报文传输，这个时候的传输使用的就是共享密钥加密方式。

###### 证书
是否加密无法确认某台服务器就是你想要访问的服务器，因此，使用了`证书`。

证书中绑定了公开密钥。

服务器会将这份公钥证书发送给客户端，接到证书的客户端进行公开密钥加密方式通信。

在认证证书的过程如下：

1. 客户端发起请求，将SSL版本、加密设置参数、与session有关的数据以及其它一些必要信息发送给服务器。
2. 服务器接收到将上述信息外带证书发送会客户端。
3. 浏览器拿到证书后，会与本地已经存在的证书作对比（大多数浏览器会事先植入常用认证机构公开的密钥）。
4. 认证通过后，客户端与服务器建立起SSL连接。

ps：怪不得有时候小网站的HTTPS证书不受信任，就是因为那些证书并不是第三方可靠机构颁发的，因此是浏览器并不是很认同它的证书。

![证书](https://ws2.sinaimg.cn/large/005VwC5mly1g74to7w22gj30yr0p14g0.jpg)

###### HTTPS的安全通信机制
![HTTPS通信机制](https://ws1.sinaimg.cn/large/005VwC5mly1g74uql36ijj30qi0p1n8g.jpg)

通信步骤如下：
1. 客户端通过发送`Client Hello`报文开始SSL通信。报文包含客户端支持的SSL指定版本、加密组件列表（所使用的加密算法以及密钥长度等）
2. 服务器可进行SSL通信时，会以`Server Hello`报文作为应答。和客户端一样，在报文中包含SSL版本以及加密组件。
3. 之后服务器发送`Certificate`报文，报文中包含公开密钥证书。
4. 最后服务器发送`Server Hello Done`报文通知客户端，最初阶段的SSL握手协商部分结束。
5. SSL第一次握手结束之后，客户端以`Client Key Exchange`报文作为回应。报文中包含通信加密中使用的一种`Pre-master secret`的随机密码串（`步骤3中的公钥进行加密`）。
6. 客户端继续发送`Change Cipher Spec`报文。该报文提示服务器，再次之后的通信使用`步骤5`中的密钥进行加密。
7. 客户端发送`Finished`报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判断标准。
8. 服务器同样发送`Change Cipher Spec`报文。
9. 服务器同样发送`Finished`报文。
10. 服务器和客户端的`Finished`报文交换文笔之后，SSL连接就算建立完成，通信会受SSL的保护，从此处开始进行应用层的通信，即发送HTTP请求。
11. 应用层协议通信，即发送HTTP响应。
12. 最后客户端断开连接。断开连接时，发送`close_notify`报文。

![交互过程](https://wx3.sinaimg.cn/large/005VwC5mly1g74xi4sk84j30qc0fwwsq.jpg)


##### 总结
本章主要介绍了HTTPS的一些东西，比较简单，HTTPS只是在HTTPS前互相试探是否支持SSL通信，交换证书，确认身份，以及交换密钥等操作，等这些操作完成之后，就建立了SSL安全连接（这点其实还是建立的TCP连接，不够是在HTTP协议之上，封装了HTTP的接口，让其再对数据进行加密而已）。尔后就是正常的HTTP协议，进行TCP连接了。

其实HTTPS就是HTTP+SSL协议而已。这是在HTTP传输前，进行了报文加密，与确认身份等连接，之前一直以为建立了SSL安全连接是一种新的连接方式，其实连接方式还是用的TCP/IP协议。
